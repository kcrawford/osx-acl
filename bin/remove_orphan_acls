#!/usr/bin/env ruby

require 'optparse'

def process(entry)
  puts File.absolute_path(entry) if OSX::ACL.from(entry).remove_orphans!
  if File.directory?(entry)
    Dir.entries(entry).each do |sub_entry|
      next if [".",".."].include?(sub_entry)
      process(File.join(entry, sub_entry))
    end
  end
end

def main
  options = {}

  opt_parser = OptionParser.new do |opt|
    opt.banner = "Usage: #{$0} [OPTIONS] path"

    opt.separator ""
    opt.separator "Options"

    opt.on("--dry-run", "outputs what would be done without modifying ACLs") do
      ENV['OSX_ACL_NOOP'] = "yes"
    end

    opt.on("--version", "outputs version information for this tool") do 
      options[:action] = "version"
    end

    opt.on("--help", "outputs help information for this tool") do 
      options[:action] = "help"
    end

  end

  opt_parser.parse!

  case options[:action]
  when "version"
    puts OSX::ACL::VERSION
  when "help"
    puts opt_parser
  else
    if ARGV[0] && File.exist?(ARGV[0])
      process(ARGV[0])
    else
      puts opt_parser
    end
  end
end

if __FILE__ == $0
  main
end

